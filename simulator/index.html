<html>
	<head>
		<title>Serf Simulator</title>
		<script src="js/jquery-2.0.3.min.js"></script>
		<script src="js/highcharts.js"></script>
		<script src="js/classy.js"></script>
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<script src="js/bootstrap.min.js"></script>
	</head>
	<body>
		<div class="container">
			<div class="page-header">
				<h1>Serf Simulator</h1>
				<p class="lead">Below is a simple simulation showing how various settings affect convergence rate</p>
			</div>
			<div class="row">
				<div id="graph"></div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<h4>Estimated max bandwidth: <span id="bytes">0</span> kbps/node</h4>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<h5>Gossip Interval</h5>
					<p>The gossip interval controls how often messages are gossiped to other nodes</p>
					<input type="text" id="interval" value="0.2"></input> seconds
				</div>
				<div class="col-md-6">
					<h5>Gossip Fanout</h5>
					<p>The gossip fanout controls how many nodes we gossip with</p>
					<input type="text" id="fanout" value="3"></input> nodes
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<h5>Nodes</h5>
					<p>This controls how many simulated nodes are in the cluster</p>
					<input type="text" id="nodes" value="30"></input>
				</div>
				<div class="col-md-6">
					<h5>Packet Loss</h5>
					<p>This controsl the amount of simulated packet loss [0, 100)</p>
					<input type="text" id="packetloss" value="0"></input> % lost packets
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<h5>Node failures</h5>
					<p>This controls what percent of simulated nodes are failed</p>
					<input type="text" id="failed" value="0"></input> % failed
				</div>
				<div class="col-md-6">
				</div>
			</div>
			<div style="margin-bottom: 40px"></div>
		</div>
	</body>
	<script type="text/javascript">
	function graph_settings() {
		return {
			chart: {
                type: 'spline'
            },
			title: {
				text: null
			},
			xAxis: {
				title: {
					text: "Time (sec)",
				}
			},
            yAxis: {
                title: {
                    text: 'Convergence %'
                },
				min: 0.0,
				max: 100.0
            },
			tooltip: {
				formatter: function() {
                        return '<b>'+ (Math.round(this.y*1000.0)/1000.0) +'%</b><br/>'
                }
            },
			legend: {
				enabled: false
			},
			series: [{
                name: 'Convergence Rate',
                data: []
            }]
		}
	}

	function create_graph() {
		$('#graph').highcharts(graph_settings())
		return $('#graph').highcharts()
	}

	var Simulator = Class.$extend({
	  __init__ : function(graph, bytes, maxConverge) {
		this.graph = graph
		this.bytes = bytes
		this.maxConverge = maxConverge
		this.interval = 0.2
		this.fanout = 3
		this.nodes = 30
		this.packetLoss = 0
		this.nodeFail = 0
	  },

	  convergenceAtRound: function(x) {
		var contact = (this.fanout / this.nodes) * (1 - this.packetLoss) * (1 - this.nodeFail)
		var numInf = this.nodes / (1 + (this.nodes+1) * Math.pow(Math.E, -1*contact*this.nodes*x))
	    return numInf / this.nodes
	  },

	  roundLength: function() {
		return this.interval
	  },

	  seriesData: function() {
		var data = []
		var lastVal = 0
		var round = 0
		var roundLength = this.roundLength()
		while (lastVal < this.maxConverge && round < 100) {
			lastVal = this.convergenceAtRound(round)
			data.push([round * roundLength, lastVal*100.0])
			round++
	    }
		return data
	  },

	  bytesUsed: function() {
		 var roundLength = this.roundLength()
	     var roundsPerSec = 1 / roundLength
		 var packetSize = 1400
		 var send = packetSize * this.fanout * roundsPerSec
		 return send * 2
	  },

	  draw: function() {
		var data = this.seriesData()
		this.graph.series[0].setData(data, false)
		this.graph.redraw()

		var used = Math.round((this.bytesUsed() / 1024) * 10) / 10
		this.bytes.html(""+used)
	  }
	})

	function update_interval(elem, simulator) {
		var val = elem.value
		var interval = Number(val)
		if (isNaN(interval)) {
			alert("Gossip interval must be a number!")
			return
		}
		if (interval <= 0) {
			alert("Gossip interval must be a positive value!")
			return
		}
		simulator.interval = interval
		simulator.draw()
		console.log("Redraw with interval set to: " + interval)
	}


	function update_fanout(elem, simulator) {
		var val = elem.value
		var fanout = Number(val)
		if (isNaN(fanout)) {
			alert("Gossip fanout must be a number!")
			return
		}
		if (fanout <= 0) {
			alert("Gossip fanout must be a positive value!")
			return
		}
		simulator.fanout = fanout
		simulator.draw()
		console.log("Redraw with fanout set to: " + fanout)
	}

	function update_nodes(elem, simulator) {
		var val = elem.value
		var nodes = Number(val)
		if (isNaN(nodes)) {
			alert("Node count must be a number!")
			return
		}
		if (nodes <= 1) {
			alert("Must have at least one node")
			return
		}
		simulator.nodes = nodes
		simulator.draw()
		console.log("Redraw with nodes set to: " + nodes)
	}

	function update_packetloss(elem, simulator) {
		var val = elem.value
		var pkt = Number(val)
		if (isNaN(pkt)) {
			alert("Packet loss must be a number!")
			return
		}
		if (pkt < 0 || pkt >= 100) {
			alert("Packet loss must be greater or equal to 0 and less than 100")
			return
		}
		simulator.packetLoss = (pkt / 100.0)
		simulator.draw()
		console.log("Redraw with packet loss set to: " + pkt)
	}

	function update_failed(elem, simulator) {
		var val = elem.value
		var failed = Number(val)
		if (isNaN(failed)) {
			alert("Failure rate must be a number!")
			return
		}
		if (failed < 0 || failed >= 100) {
			alert("Failure rate must be greater or equal to 0 and less than 100")
			return
		}
		simulator.nodeFail = (failed / 100.0)
		simulator.draw()
		console.log("Redraw with failure rate set to: " + failed)
	}

	// wait for dom ready
	$(function(){
		var bytes = $("#bytes")
		var graph = create_graph()
		var simulator = new Simulator(graph, bytes, 0.9999)
		simulator.draw()

		var interval = $("#interval")
		interval.change(function() { update_interval(interval[0], simulator) })

		var fanout = $("#fanout")
		fanout.change(function() { update_fanout(fanout[0], simulator) })

		var nodes = $("#nodes")
		nodes.change(function() { update_nodes(nodes[0], simulator) })

		var loss = $("#packetloss")
		loss.change(function() { update_packetloss(loss[0], simulator) })

		var failed = $("#failed")
		failed.change(function() { update_failed(failed[0], simulator) })
	})
	</script>
</html>
